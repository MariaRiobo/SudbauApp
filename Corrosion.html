<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CorrosiÃ³n</title>
    <link rel="stylesheet" href="css/app.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

</head>
<body>
    <div class="container">
        <div class="header-corrosion">
            <div class="header-left">
                <img src="img/logo.png" alt="Logo de la empresa" class="logo">
                <div class="titulo-y-tubo">
                <h1 class="title">CORROSIÃ“N</h1>
                <p class="subtitulo-tubo">Tubo NÂº <span id="numero-tubo"></span></p>
                </div>
            </div>
        </div>


        <div class="botones-container">
            <a href="desgaste.html" class="btn-color amarillo">Amarillo</a>
            <a href="desgaste.html" class="btn-color azul">Azul</a>
            <a href="desgaste.html" class="btn-color verde">Verde</a>
            <a href="desgaste.html" class="btn-color rojo">Rojo</a>
            <a href="desgaste.html" class="btn-color blanco">Blanco</a>
        </div>


        <div class="controles">
            <a href="InicioSesion.html" class="btn-volver">Volver</a>
            <button  class="btn-parada">Parada</button>
        </div>

        <div class="justificacion-container" style="display: none;">
            <p>Fecha y hora: <span id="fecha-hora"></span></p>
            <label for="justificacion">JustificaciÃ³n:</label>
            <textarea id="justificacion" rows="4"></textarea>
            <button class="btn-justificar">Justificar</button>
        </div>

    <button class="btn-arranque" style="display:none;">Arranque</button>

    </div>

<script>
    /* =====Local storage===== */
    function loadIntervencion() {
      const raw = localStorage.getItem('intervencionActual');
      if (!raw) { window.location.href = 'InicioSesion.html'; return null; }
      const itv = JSON.parse(raw);
      if (!itv.draft) itv.draft = {};
      if (!itv.eventos) itv.eventos = [];
      return itv;
    }
    function saveIntervencion(itv) {
      localStorage.setItem('intervencionActual', JSON.stringify(itv));
    }
    function pushEvento(tipo, extra = {}) {
      const itv = loadIntervencion(); if (!itv) return;
      itv.eventos.push({
        tipo, tubo: Number(itv.tuboActual),
        at: new Date().toISOString(),
        ...extra
      });
      saveIntervencion(itv);
    }

    const justificacionContainer = document.querySelector('.justificacion-container');
    const btnParada = document.querySelector('.btn-parada');
    const btnArranque = document.querySelector('.btn-arranque');
    const fechaHoraSpan = document.getElementById('fecha-hora');
    const btnJustificar = document.querySelector('.btn-justificar');
    const botonesColor = document.querySelectorAll('.btn-color');

    // Mostrar nÃºmero de tubo
    const itv = loadIntervencion();
    if (!itv) { /* ya redirigiÃ³ */ } 
    else {
      const numeroTubo = document.getElementById('numero-tubo');
      if (numeroTubo) numeroTubo.textContent = itv.tuboActual;
    }

    /* =====BotÃ³n parada===== */
    btnParada.addEventListener('click', () => {
      const now = new Date();
      fechaHoraSpan.textContent = now.toLocaleString();
      justificacionContainer.style.display = 'block';

      botonesColor.forEach(btn => btn.classList.add('desactivado'));
      btnParada.disabled = true;

      pushEvento('parada');
    });

    // BotÃ³n JUSTIFICAR â†’ sÃ³lo muestra ARRANQUE
    btnJustificar.addEventListener('click', () => {
      btnArranque.style.display = 'block';
      // Log opcional con el texto
      const txt = (document.getElementById('justificacion')?.value || '').trim();
      pushEvento('justificacion', { texto: txt });
    });

    btnArranque.addEventListener('click', () => {
      botonesColor.forEach(btn => btn.classList.remove('desactivado'));
      justificacionContainer.style.display = 'none';
      btnArranque.style.display = 'none';
      btnParada.disabled = false;

      pushEvento('arranque');
    });

    /* =====Local storage===== */
    document.querySelectorAll('.botones-container .btn-color').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        // Detectar color por clase
        const cls = e.currentTarget.className.split(/\s+/);
        const color = ['amarillo','azul','verde','rojo','blanco'].find(c => cls.includes(c)) || 'desconocido';

        const itv2 = loadIntervencion(); if (!itv2) return;
        itv2.draft.corrosionColor = color;   // ðŸ‘ˆ queda guardado para este tubo
        saveIntervencion(itv2);

        // (Opcional) log simple
        pushEvento('corrosionSeleccionada', { color });

        // Ir a la siguiente pantalla como siempre
        window.location.href = e.currentTarget.getAttribute('href'); // desgaste.html
      });
    });
  </script>

</body>
</html>
