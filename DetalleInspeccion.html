<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalle de Inspección</title>
  
  <meta name="theme-color" content="#0055AA">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Sudbaü App: Modo Operador Activo'))
          .catch(err => console.log('Error al registrar Service Worker', err));
      });
    }
  </script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --blue-1: #0055AA;
      --blue-2: #05145A;
      --bg: #0A1C4D;
      --white: #FFFFFF;
      --text: #0F0F14;
      --border: #E5E7EB;
    }

    body {
      margin: 0;
      font-family: "Noto Sans", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
    }

    .container {
      width: min(1000px, 100%);
      background: var(--white);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .header-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
    }

    .btn-back {
      text-decoration: none;
      color: var(--blue-1);
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn-back:hover { text-decoration: underline; }

    h1 {
      margin: 0;
      font-family: "Kanit", sans-serif;
      color: var(--blue-2);
      font-size: 24px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
      background: #F3F4F6;
      padding: 20px;
      border-radius: 12px;
    }

    .summary-item label {
      display: block;
      font-size: 12px;
      color: #6B7280;
      font-weight: bold;
      text-transform: uppercase;
    }
    .summary-item span {
      font-size: 16px;
      color: var(--blue-2);
      font-weight: 500;
    }

    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead { background: var(--blue-1); color: white; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
    th { font-family: "Kanit", sans-serif; font-weight: 500; }
    tr:nth-child(even) { background-color: #F9FAFB; }
    tr:hover { background-color: #F0F9FF; }

    /* --- ÓVALOS CON TAMAÑO GRADUAL --- */
    .oval-badge {
      display: inline-block;
      border-radius: 20px;
      font-weight: bold;
      font-size: 11px;
      color: white;
      text-align: center;
      text-transform: uppercase;
    }

    /* G2: Pequeño y Amarillo */
    .oval-g2 { 
      background-color: #FFD700; 
      color: #000; 
      padding: 3px 12px; 
      min-width: 40px;
      border: 1px solid #DAA520;
    }
    /* G3: Mediano y Azul */
    .oval-g3 { 
      background-color: #0055AA; 
      padding: 4px 18px; 
      min-width: 60px;
    }
    /* G4: Grande y Verde */
    .oval-g4 { 
      background-color: #28a745; 
      padding: 5px 24px; 
      min-width: 80px;
    }
    /* G5: El más grande y Rojo (Máxima alerta) */
    .oval-g5 { 
      background-color: #dc3545; 
      padding: 6px 32px; 
      min-width: 100px;
      box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
    }
    /* Ungrade: Sutil y gris */
    .oval-none { 
      background-color: #E5E7EB; 
      color: #6B7280; 
      padding: 2px 10px;
      font-weight: normal;
    }

    .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .badge-defect { background: #FEE2E2; color: #991B1B; border: 1px solid #F87171; text-transform: uppercase; }
    .badge-ok { color: #166534; font-weight: bold; }
    .badge-blue { background: #DBEAFE; color: #1E40AF; }
    .badge-live { background: #DCFCE7; color: #166534; border: 1px solid #166534; }

    #loading { text-align: center; font-size: 18px; color: #666; padding: 40px; }
  </style>
</head>
<body>

  <div class="container">
    <div class="header-nav">
      <a href="UsuarioDashboard.html" class="btn-back">← Volver al Dashboard</a>
      <img src="img/logoHorizontal.png" alt="Logo" style="height:30px;">
    </div>

    <div id="loading">Cargando detalles de la inspección...</div>

    <div id="content" style="display: none;">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <h1 id="tituloPozo">Pozo: ...</h1>
          <span id="badgeLive" class="badge badge-live" style="display:none;">EN VIVO</span>
      </div>
      <p style="margin-top:0; color:#666;" id="subtituloFecha">...</p>

      <div class="summary-grid">
        <div class="summary-item"><label>Cliente</label><span id="valCliente">-</span></div>
        <div class="summary-item"><label>Área</label><span id="valArea">-</span></div>
        <div class="summary-item"><label>OT</label><span id="valOT">-</span></div>
        <div class="summary-item"><label>Solicitado por</label><span id="valSolicitado">-</span></div>
        <div class="summary-item"><label>Operador</label><span id="valOperador">-</span></div>
        <div class="summary-item"><label>Total Tubos</label><span id="valTotal">-</span></div>
      </div>

      <h3>Detalle Tubo a Tubo</h3>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Nro</th>
              <th>Tipo</th>
              <th>Desgaste</th>
              <th>Corrosión</th>
              <th>Cupla</th>
              <th>Observaciones / Justif.</th>
            </tr>
          </thead>
          <tbody id="tablaCuerpo"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMeOkD8NMaPwVRGqeQxqnrpnwPfjwjiuw",
      authDomain: "sudbau-app.firebaseapp.com",
      projectId: "sudbau-app",
      storageBucket: "sudbau-app.firebasestorage.app",
      messagingSenderId: "803219965094",
      appId: "1:803219965094:web:121e2ed15d663225202067",
      measurementId: "G-8XY511E3JL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const docId = params.get('id');
    const esLiveUrl = params.get('live') === 'true';

    if (!docId) {
      alert("No se especificó una inspección.");
      window.location.href = "UsuarioDashboard.html";
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "usuario.html"; 
        return;
      }
      cargarDetalle(docId);
    });

    function formatGradoGradual(valor) {
      if (!valor || valor === "-") return "-";
      const v = valor.toUpperCase().trim();
      let claseOval = "oval-none";
      
      if (v === "G2") claseOval = "oval-g2";
      else if (v === "G3") claseOval = "oval-g3";
      else if (v === "G4") claseOval = "oval-g4";
      else if (v === "G5") claseOval = "oval-g5";

      return `<span class="oval-badge ${claseOval}">${v}</span>`;
    }

    function formatCuplaOval(valor) {
      if (!valor || valor === "-") return "-";
      const v = valor.toLowerCase();
      if (v.includes("defect") || v.includes("mala") || v.includes("daño") || v.includes("no")) {
        return `<span class="badge badge-defect">${valor.toUpperCase()}</span>`;
      }
      return `<span class="badge-ok">${valor}</span>`;
    }

    async function cargarDetalle(id) {
      try {
        let docSnap;
        let coleccionUtilizada = "";

        if (esLiveUrl) {
            docSnap = await getDoc(doc(db, "inspecciones_live", id));
            coleccionUtilizada = "inspecciones_live";
        }

        if (!docSnap || !docSnap.exists()) {
            docSnap = await getDoc(doc(db, "inspecciones", id));
            coleccionUtilizada = "inspecciones";
        }

        if (!docSnap.exists()) {
          document.getElementById("loading").textContent = "El documento no existe.";
          return;
        }

        const data = docSnap.data();
        await mostrarDatos(data, id, coleccionUtilizada);

      } catch (e) {
        console.error(e);
        document.getElementById("loading").textContent = "Error al leer datos.";
      }
    }

    async function mostrarDatos(data, id, colName) {
      document.getElementById("loading").style.display = "none";
      document.getElementById("content").style.display = "block";

      if (colName === "inspecciones_live") {
          document.getElementById("badgeLive").style.display = "inline-block";
      }

      document.getElementById("tituloPozo").textContent = `Pozo: ${data.pozo || "Sin Datos"}`;
      
      let fecha = "En curso...";
      if (data.createdAt && data.createdAt.seconds) {
        fecha = new Date(data.createdAt.seconds * 1000).toLocaleString();
      }
      document.getElementById("subtituloFecha").textContent = `Fecha: ${fecha}`;

      document.getElementById("valCliente").textContent = data.cliente || "-";
      document.getElementById("valArea").textContent = data.area || "-";
      document.getElementById("valOT").textContent = data.ot || "-";
      document.getElementById("valSolicitado").textContent = data.solicitado || "-";
      document.getElementById("valOperador").textContent = data.operador || "-";
      document.getElementById("valTotal").textContent = data.tuboActual || data.tubosCount || "0";

      const tbody = document.getElementById("tablaCuerpo");
      tbody.innerHTML = ""; 

      let listaParaMostrar = [];

      if (colName === "inspecciones_live") {
          const subSnap = await getDocs(collection(db, colName, id, "tubos"));
          subSnap.forEach(tDoc => {
              const d = tDoc.data();
              listaParaMostrar.push({
                  nro: d.tuboNro || d.nro,
                  tipo: d.tipo || "-",
                  desgaste: d.desgaste || "-",
                  corrosion: d.corrosion || "-",
                  cupla: d.cupla_status || d.cupla || "-",
                  justif: d.justificacion || ""
              });
          });
      } else {
          const tubosArray = data.tubos || [];
          tubosArray.forEach(t => {
              const d = t.draft || t; 
              listaParaMostrar.push({
                  nro: t.nro || d.tuboNro,
                  tipo: d.tipo || "-",
                  desgaste: d.desgaste || "-",
                  corrosion: d.corrosion || "-",
                  cupla: d.cupla_status || d.cupla || "-",
                  justif: d.justificacion || ""
              });
          });
      }

      listaParaMostrar.sort((a, b) => Number(a.nro) - Number(b.nro));

      listaParaMostrar.forEach(t => {
        const tr = document.createElement("tr");
        const obsHtml = t.justif ? `<span class="badge badge-blue">${t.justif}</span>` : "-";

        tr.innerHTML = `
          <td><b>${t.nro}</b></td>
          <td>${t.tipo}</td>
          <td>${formatGradoGradual(t.desgaste)}</td>
          <td>${formatGradoGradual(t.corrosion)}</td>
          <td>${formatCuplaOval(t.cupla)}</td>
          <td>${obsHtml}</td>
        `;
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>