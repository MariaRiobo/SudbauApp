<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Corrosión</title>

<meta name="theme-color" content="#0055AA">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Sudbaü App: Modo Operador Activo'))
          .catch(err => console.log('Error al registrar Service Worker', err));
      });
    }
  </script>

  <link rel="stylesheet" href="css/app.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="header-corrosion">
      <div class="header-left">
        <img src="img/logo.png" alt="Logo de la empresa" class="logo">
        <div class="titulo-y-tubo">
          <p class="subtitulo-tubo">Tubo Nº <span id="numero-tubo"></span></p>
          <h1 class="title">CORROSIÓN</h1>
        </div>
      </div>
    </div>

    <div class="botones-container">
      <a href="tipo.html" class="btn-color amarillo">G2</a>
      <a href="tipo.html" class="btn-color azul">G3</a>
      <a href="tipo.html" class="btn-color verde">G4</a>
      <a href="tipo.html" class="btn-color rojo">G5</a>
      <a href="tipo.html" class="btn-color blanco">UNGRADE</a>
    </div>

    <div class="controles">
      <a href="desgaste.html" class="btn-volver">Volver</a>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, enableIndexedDbPersistence, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMeOkD8NMaPwVRGqeQxqnrpnwPfjwjiuw",
      authDomain: "sudbau-app.firebaseapp.com",
      projectId: "sudbau-app",
      storageBucket: "sudbau-app.firebasestorage.app",
      messagingSenderId: "803219965094",
      appId: "1:803219965094:web:121e2ed15d663225202067"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // PERSISTENCIA OFFLINE
    enableIndexedDbPersistence(db).catch(() => console.warn("Modo offline activo en Corrosión"));

    /* ===== Local storage ===== */
    function loadIntervencion() {
      const raw = localStorage.getItem('intervencionActual');
      if (!raw) { window.location.href = 'InicioSesion.html'; return null; }
      const itv = JSON.parse(raw);
      if (!itv.draft) itv.draft = {};
      if (!itv.eventos) itv.eventos = [];
      return itv;
    }
    function saveIntervencion(itv) {
      localStorage.setItem('intervencionActual', JSON.stringify(itv));
    }
    function pushEvento(tipo, extra = {}) {
      const itv = loadIntervencion(); if (!itv) return;
      itv.eventos.push({
        tipo,
        tubo: Number(itv.tuboActual),
        at: new Date().toISOString(),
        ...extra
      });
      saveIntervencion(itv);
    }

    /* ===== Helpers para tubos[] ===== */
    function loadTubes() {
      return JSON.parse(localStorage.getItem('tubos') || '[]');
    }
    function saveTubes(arr) {
      localStorage.setItem('tubos', JSON.stringify(arr));
    }
    function ensureTubeIndex(tubes, idx) {
      while (tubes.length <= idx) tubes.push({ nro: tubes.length + 1, draft: {}, completedAt: null });
      return tubes[idx];
    }
    function currentTubeIndex(itv) {
      return Number(itv.tuboActual || 1) - 1; 
    }
    function syncDraftFromTube() {
      const itv = loadIntervencion(); if (!itv) return;
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      const t = ensureTubeIndex(tubes, idx);
      itv.draft = { ...(t.draft || {}), ...(itv.draft || {}) };
      saveIntervencion(itv);
    }
    function syncTubeFromDraft() {
      const itv = loadIntervencion(); if (!itv) return;
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      const t = ensureTubeIndex(tubes, idx);
      t.draft = { ...(t.draft || {}), ...(itv.draft || {}) };
      saveTubes(tubes);
    }

    // Mostrar número de tubo + precargar draft del tubo
    const itvInit = loadIntervencion();
    if (itvInit) {
      syncDraftFromTube();
      const numeroTubo = document.getElementById('numero-tubo');
      if (numeroTubo) numeroTubo.textContent = itvInit.tuboActual;
    }

    // ==========================================
    // SINCRONIZADOR SILENCIOSO DE FONDO
    // ==========================================
    function sincronizarLiveDeFondo() {
      const itv = loadIntervencion();
      const tubos = loadTubes();
      if (!itv) return;

      const idFirebase = itv.customId || itv.liveId;
      if (!idFirebase) return;

      // 1. Guardar la cabecera (incluyendo el borrador actual)
      const headerRef = doc(db, "inspecciones_live", idFirebase);
      setDoc(headerRef, {
        cliente: itv.cliente || "",
        pozo: itv.pozo || "",
        ot: itv.ot || "",
        tuboActual: Number(itv.tuboActual),
        ultimo_draft: itv.draft || {},
        lastUpdateAt: serverTimestamp(),
        estado: "EN_PROCESO"
      }, { merge: true }).catch(() => {});

      // 2. Revisamos los ÚLTIMOS 10 TUBOS y los subimos por si faltó alguno.
      tubos.forEach(t => {
        const d = t.draft || t;
        const nroTubo = String(t.nro || d.tuboNro);
        if (!nroTubo || nroTubo === "undefined") return;

        const tuboRef = doc(db, "inspecciones_live", idFirebase, "tubos", nroTubo);
        setDoc(tuboRef, {
          tuboNro: Number(nroTubo),
          desgaste: d.desgaste || "",
          corrosion: d.corrosion || "",
          tipo: d.tipo || "",
          cupla_status: d.cupla_status || d.cupla || "",
          updatedAt: serverTimestamp()
        }, { merge: true }).catch(() => {});
      });
    }

    // Disparamos la sincronización apenas abre la página
    sincronizarLiveDeFondo();
    window.addEventListener('online', sincronizarLiveDeFondo);

    const GRADO_MAP = {
      amarillo: 'G2',
      azul: 'G3',
      verde: 'G4',
      rojo: 'G5',
      blanco: 'UNGRADE'
    };

    /* ===== Selección → guarda draft y lógica de salto (SIN FIREBASE) ===== */
    document.querySelectorAll('.botones-container .btn-color').forEach(a => {
      a.addEventListener('click', (e) => {
        if (a.classList.contains('desactivado')) { e.preventDefault(); return; }
        e.preventDefault();

        const cls = e.currentTarget.className.split(/\s+/);
        const colorCorrosion = Object.keys(GRADO_MAP).find(c => cls.includes(c));
        const corrosion = GRADO_MAP[colorCorrosion] || 'UNGRADE';

        const itv2 = loadIntervencion(); 
        if (!itv2) return;

        itv2.draft.corrosion = corrosion;
        const desgaste = itv2.draft.desgaste;

        // ACÁ SACAMOS EL SETDOC PARA QUE NO HAYA PROBLEMAS DE RED.
        // LA PRÓXIMA PANTALLA SE ENCARGARÁ DE SUBIR ESTE DRAFT A FIREBASE EN EL FONDO.

        if (desgaste === 'G2' && corrosion === 'G2') {
          itv2.draft.tipo = '-';
          saveIntervencion(itv2);
          syncTubeFromDraft();
          pushEvento('corrosionSeleccionada', { corrosion });
          pushEvento('tipoAutoSeleccionado', { tipo: '-', motivo: 'G2+G2' });
          window.location.href = 'cupla.html';
        } else {
          saveIntervencion(itv2);
          syncTubeFromDraft();
          pushEvento('corrosionSeleccionada', { corrosion });
          window.location.href = 'tipo.html';
        }
      });
    });
  </script>
</body>
</html>