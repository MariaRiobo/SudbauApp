<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cupla</title>

  <meta name="theme-color" content="#0055AA">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Sudbaü App: Modo Operador Activo'))
          .catch(err => console.log('Error al registrar Service Worker', err));
      });
    }
  </script>
  
  <link rel="stylesheet" href="css/app.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .tipo-btn.selected { outline: 3px solid rgba(0,85,170,.25); transform: translateY(1px); }
    .tipo-btn.desactivado { pointer-events: none; filter: grayscale(100%); opacity: .5; }

    .seleccion-banner {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; padding: 10px 14px; border-radius: 10px; margin: 10px 0 8px;
      background: #E9F3FF; font-family: 'Noto Sans', sans-serif; font-size: 14px;
    }
    .seleccion-banner[hidden]{ display:none; }
    .seleccion-banner button {
      background: transparent; border: 0; text-decoration: underline; cursor: pointer;
      font-family: 'Kanit', sans-serif; font-size: 14px;
    }

    .btn:disabled,
    .btn[disabled],
    #btn-siguiente-tubo:disabled,
    #btn-finalizar:disabled {
      opacity: 0.5;
      filter: grayscale(100%);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn:disabled:hover,
    .btn:disabled:focus { box-shadow: none; outline: none; }
  </style>
</head>

<body>
  <div class="container container-large container-wide">
    <div class="header-corrosion">
      <div class="header-left">
        <img src="img/logo.png" alt="Logo de la empresa" class="logo">
        <div class="titulo-y-tubo">
          <p class="subtitulo-tubo">Tubo Nº <span id="numero-tubo"></span></p>
          <h1 class="title">CUPLA</h1>
        </div>
      </div>
    </div>

    <div class="tipo-container">
      <div class="tipo-item">
        <a href="" class="tipo-btn" data-code="buena">BUENA</a>
        <p>Cupla buena</p>
      </div>
      <div class="tipo-item">
        <a href="" class="tipo-btn" data-code="defectuosa">DEFECTUOSA</a>
        <p>Cupla defectuosa</p>
      </div>
    </div>

    <div id="seleccion-banner" class="seleccion-banner" hidden aria-live="polite">
      <span id="seleccion-texto"></span>
      <button id="seleccion-cambiar" type="button">Cambiar</button>
    </div>

    <div class="controles" id="controles-cta">
      <a href="tipo.html" class="btn-volver">Atrás</a>
      <button id="btn-siguiente-tubo" class="btn" disabled>Siguiente tubo</button>
    </div>
    <div class="controles">
      <button id="btn-finalizar" class="btn btn-danger" disabled>Finalizar inspección</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMeOkD8NMaPwVRGqeQxqnrpnwPfjwjiuw",
      authDomain: "sudbau-app.firebaseapp.com",
      projectId: "sudbau-app",
      storageBucket: "sudbau-app.firebasestorage.app",
      messagingSenderId: "803219965094",
      appId: "1:803219965094:web:121e2ed15d663225202067"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    enableIndexedDbPersistence(db).catch(() => {});

    // Lógica de LocalStorage
    function loadIntervencion() {
      const raw = localStorage.getItem('intervencionActual');
      if (!raw) { window.location.href = 'InicioSesion.html'; return null; }
      const itv = JSON.parse(raw);
      if (!itv.draft) itv.draft = {};
      return itv;
    }
    function saveIntervencion(itv){ localStorage.setItem('intervencionActual', JSON.stringify(itv)); }
    
    function setDraft(field, value){
      const itv = loadIntervencion(); if (!itv) return;
      if (value === undefined) delete itv.draft[field]; else itv.draft[field] = value;
      saveIntervencion(itv);
    }

    function loadTubes(){ return JSON.parse(localStorage.getItem('tubos') || '[]'); }
    function saveTubes(arr){ localStorage.setItem('tubos', JSON.stringify(arr)); }
    function currentTubeIndex(itv){ return Number(itv.tuboActual || 1) - 1; }

    function syncTubeFromDraft(){
      const itv = loadIntervencion(); if (!itv) return;
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      if (!tubes[idx]) tubes[idx] = { nro: idx + 1, draft: {}, completedAt: null };
      tubes[idx].draft = { ...(tubes[idx].draft||{}), ...(itv.draft||{}) };
      saveTubes(tubes);
    }

    // ==========================================
    // NUEVO: SINCRONIZADOR SILENCIOSO DE FONDO
    // ==========================================
    function sincronizarLiveDeFondo() {
      const itv = loadIntervencion();
      const tubos = loadTubes();
      if (!itv) return;

      const idFirebase = itv.customId || itv.liveId;
      if (!idFirebase) return;

      // 1. Guardar la cabecera
      const headerRef = doc(db, "inspecciones_live", idFirebase);
      setDoc(headerRef, {
        cliente: itv.cliente || "",
        pozo: itv.pozo || "",
        ot: itv.ot || "",
        tuboActual: Number(itv.tuboActual),
        lastUpdateAt: serverTimestamp(),
        estado: "EN_PROCESO"
      }, { merge: true }).catch(() => {});

      // 2. Revisamos los ÚLTIMOS 10 TUBOS y los subimos. 
      tubos.forEach(t => {
        const d = t.draft || t;
        const nroTubo = String(t.nro || d.tuboNro);
        if (!nroTubo || nroTubo === "undefined") return;

        const tuboRef = doc(db, "inspecciones_live", idFirebase, "tubos", nroTubo);
        setDoc(tuboRef, {
          tuboNro: Number(nroTubo),
          desgaste: d.desgaste || "",
          corrosion: d.corrosion || "",
          tipo: d.tipo || "",
          cupla_status: d.cupla_status || d.cupla || "",
          updatedAt: serverTimestamp()
        }, { merge: true }).catch(() => {});
      });
    }

    // DISPARAR SINCRONIZACIÓN AUTOMÁTICA AL ABRIR LA PÁGINA
    sincronizarLiveDeFondo();
    window.addEventListener('online', sincronizarLiveDeFondo); // Por si vuelve el WiFi estando acá


    /* ===== UI Eventos ===== */
    const itvInit = loadIntervencion();
    const tuboSpan = document.getElementById('numero-tubo');
    if (itvInit && tuboSpan) tuboSpan.textContent = itvInit.tuboActual;

    const tipoBtns = document.querySelectorAll('.tipo-btn');
    const btnSiguiente = document.getElementById('btn-siguiente-tubo');
    const btnFinalizar = document.getElementById('btn-finalizar');
    const banner = document.getElementById('seleccion-banner');
    const bannerTexto = document.getElementById('seleccion-texto');
    const bannerCambiar = document.getElementById('seleccion-cambiar');

    let seleccionActual = null;

    tipoBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        seleccionActual = btn.dataset.code;
        tipoBtns.forEach(b => (b === btn) ? b.classList.add('selected') : b.classList.add('desactivado'));
        btnSiguiente.disabled = false;
        btnFinalizar.disabled = false;
        bannerTexto.textContent = `Seleccionaste: ${seleccionActual.toUpperCase()}`;
        banner.hidden = false;
        setDraft('cupla_status', seleccionActual);
        syncTubeFromDraft();
      });
    });

    bannerCambiar.addEventListener('click', () => {
      seleccionActual = null;
      tipoBtns.forEach(b => b.classList.remove('selected', 'desactivado'));
      btnSiguiente.disabled = true;
      btnFinalizar.disabled = true;
      banner.hidden = true;
      setDraft('cupla_status', undefined);
      syncTubeFromDraft();
    });

    // ==========================================
    // BOTÓN SIGUIENTE: SOLO GUARDA LOCAL Y SALTA. ¡NO TOCA FIREBASE!
    // ==========================================
    btnSiguiente.addEventListener('click', () => {
      if (!seleccionActual) return;
      
      const itv = loadIntervencion();
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      const dataTubo = { ...itv.draft, cupla_status: seleccionActual };

      // Guardado Local
      if (tubes[idx]) {
        tubes[idx].completedAt = new Date().toISOString();
        tubes[idx].draft = dataTubo; // Aseguramos que el dato final quede en el tubo
      }
      saveTubes(tubes);

      // Preparamos para el tubo siguiente
      itv.tuboActual = Number(itv.tuboActual) + 1;
      itv.draft = {}; 
      saveIntervencion(itv);

      // SALTO INMEDIATO (El próximo tubo ejecutará sincronizarLiveDeFondo)
      window.location.href = 'desgaste.html';
    });

    // ==========================================
    // BOTÓN FINALIZAR: IGUAL, SOLO GUARDA LOCAL Y SALTA
    // ==========================================
    btnFinalizar.addEventListener('click', () => {
      if (!seleccionActual) return;
      
      const itv = loadIntervencion();
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      const dataTubo = { ...itv.draft, cupla_status: seleccionActual };

      if (tubes[idx]) {
        tubes[idx].completedAt = new Date().toISOString();
        tubes[idx].draft = dataTubo;
      }
      saveTubes(tubes);
      saveIntervencion(itv);

      // SALTO INMEDIATO a pantalla final
      window.location.href = 'findelproceso.html';
    });
  </script>
</body>
</html>