<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cupla</title>

  <meta name="theme-color" content="#0055AA">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Sudbaü App: Modo Operador Activo'))
          .catch(err => console.log('Error al registrar Service Worker', err));
      });
    }
  </script>
  
  <link rel="stylesheet" href="css/app.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .tipo-btn.selected { outline: 3px solid rgba(0,85,170,.25); transform: translateY(1px); }
    .tipo-btn.desactivado { pointer-events: none; filter: grayscale(100%); opacity: .5; }

    .seleccion-banner {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; padding: 10px 14px; border-radius: 10px; margin: 10px 0 8px;
      background: #E9F3FF; font-family: 'Noto Sans', sans-serif; font-size: 14px;
    }
    .seleccion-banner[hidden]{ display:none; }
    .seleccion-banner button {
      background: transparent; border: 0; text-decoration: underline; cursor: pointer;
      font-family: 'Kanit', sans-serif; font-size: 14px;
    }

    .btn:disabled,
    .btn[disabled],
    #btn-siguiente-tubo:disabled,
    #btn-finalizar:disabled {
      opacity: 0.5;
      filter: grayscale(100%);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn:disabled:hover,
    .btn:disabled:focus { box-shadow: none; outline: none; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMeOkD8NMaPwVRGqeQxqnrpnwPfjwjiuw",
      authDomain: "sudbau-app.firebaseapp.com",
      projectId: "sudbau-app",
      storageBucket: "sudbau-app.firebasestorage.app",
      messagingSenderId: "803219965094",
      appId: "1:803219965094:web:121e2ed15d663225202067",
      measurementId: "G-8XY511E3JL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Exponemos las funciones necesarias para el script de abajo
    window.SUDBAU_DB = db;
    window.FB_DOC = doc;
    window.FB_SET = setDoc;
    window.FB_TS = serverTimestamp;
  </script>
</head>

<body>
  <div class="container container-large container-wide">
    <div class="header-corrosion">
      <div class="header-left">
        <img src="img/logo.png" alt="Logo de la empresa" class="logo">
        <div class="titulo-y-tubo">
          <p class="subtitulo-tubo">Tubo Nº <span id="numero-tubo"></span></p>
          <h1 class="title">CUPLA</h1>
        </div>
      </div>
    </div>

    <div class="tipo-container">
      <div class="tipo-item">
        <a href="" class="tipo-btn" data-code="buena">BUENA</a>
        <p>Cupla buena</p>
      </div>
      <div class="tipo-item">
        <a href="" class="tipo-btn" data-code="defectuosa">DEFECTUOSA</a>
        <p>Cupla defectuosa</p>
      </div>
    </div>

    <div id="seleccion-banner" class="seleccion-banner" hidden aria-live="polite">
      <span id="seleccion-texto"></span>
      <button id="seleccion-cambiar" type="button">Cambiar</button>
    </div>

    <div class="controles" id="controles-cta">
      <a href="./tipo.html" class="btn-volver">Atrás</a>
      <button id="btn-siguiente-tubo" class="btn" disabled>Siguiente tubo</button>
    </div>
    <div class="controles">
      <button id="btn-finalizar" class="btn btn-danger" disabled>Finalizar inspección</button>
    </div>
  </div>

  <script>
    /* ===== Helpers de estado (Tu lógica original) ===== */
    function loadIntervencion() {
      const raw = localStorage.getItem('intervencionActual');
      if (!raw) { window.location.href = 'InicioSesion.html'; return null; }
      const itv = JSON.parse(raw);
      if (!itv.draft) itv.draft = {};
      return itv;
    }
    function saveIntervencion(itv){ localStorage.setItem('intervencionActual', JSON.stringify(itv)); }
    
    function setDraft(field, value){
      const itv = loadIntervencion(); if (!itv) return;
      if (value === undefined) delete itv.draft[field]; else itv.draft[field] = value;
      saveIntervencion(itv);
    }

    function loadTubes(){ return JSON.parse(localStorage.getItem('tubos') || '[]'); }
    function saveTubes(arr){ localStorage.setItem('tubos', JSON.stringify(arr)); }
    
    function currentTubeIndex(itv){ return Number(itv.tuboActual || 1) - 1; }

    function syncTubeFromDraft(){
      const itv = loadIntervencion(); if (!itv) return;
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      if (!tubes[idx]) tubes[idx] = { nro: idx + 1, draft: {}, completedAt: null };
      tubes[idx].draft = { ...(tubes[idx].draft||{}), ...(itv.draft||{}) };
      saveTubes(tubes);
    }

    /* =========================================================
      ✅ LÓGICA DE SUBIDA EN TIEMPO REAL (Para el Jefe)
    ========================================================= */
    async function guardarTuboEnVivo(itv, dataTubo, esFinal = false) {
      try {
        const db = window.SUDBAU_DB;
        const docFn = window.FB_DOC;
        const setFn = window.FB_SET;
        const tsFn = window.FB_TS;

        if (!db || !docFn) return;

        // Aseguramos que la intervención tenga un ID único para Firebase
        if (!itv.liveId) {
          const d = new Date();
          itv.liveId = `LIVE-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
          saveIntervencion(itv);
        }

        // 1) Cabecera: Para que el dashboard sepa qué está pasando
        const headerRef = docFn(db, "inspecciones_live", itv.liveId);
        await setFn(headerRef, {
          cliente: (itv.cliente || "").toString().toUpperCase().trim(),
          pozo: itv.pozo || "",
          area: itv.area || "",
          ot: itv.ot || "",
          operador: itv.operador || "",
          tuboActual: Number(itv.tuboActual),
          lastUpdateAt: tsFn(),
          estado: esFinal ? "FINALIZADA" : "EN_PROCESO"
        }, { merge: true });

        // 2) Detalle del Tubo: Lo que se muestra en la tabla del cliente
        const tuboRef = docFn(db, "inspecciones_live", itv.liveId, "tubos", String(itv.tuboActual));
        await setFn(tuboRef, {
          tuboNro: Number(itv.tuboActual),
          desgaste: dataTubo.desgaste || "",
          corrosion: dataTubo.corrosion || "",
          tipo: dataTubo.tipo || "",
          cupla_status: dataTubo.cupla_status || "",
          completedAt: new Date().toISOString(),
          updatedAt: tsFn()
        }, { merge: true });

        console.log("✅ Sincronizado con Dashboard del Jefe");
      } catch (err) {
        console.error("❌ Error subiendo a Firebase:", err);
      }
    }

    /* ===== UI Init y Eventos (Tu lógica original intacta) ===== */
    const itvInit = loadIntervencion();
    const tuboSpan = document.getElementById('numero-tubo');
    if (itvInit && tuboSpan) tuboSpan.textContent = itvInit.tuboActual;

    const tipoBtns = document.querySelectorAll('.tipo-btn');
    const btnSiguiente = document.getElementById('btn-siguiente-tubo');
    const btnFinalizar = document.getElementById('btn-finalizar');
    const banner = document.getElementById('seleccion-banner');
    const bannerTexto = document.getElementById('seleccion-texto');
    const bannerCambiar = document.getElementById('seleccion-cambiar');

    let seleccionActual = null;

    tipoBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        seleccionActual = btn.dataset.code;
        tipoBtns.forEach(b => (b === btn) ? b.classList.add('selected') : b.classList.add('desactivado'));

        btnSiguiente.disabled = false;
        btnFinalizar.disabled = false;
        bannerTexto.textContent = `Seleccionaste: ${seleccionActual.toUpperCase()}`;
        banner.hidden = false;

        setDraft('cupla_status', seleccionActual);
        syncTubeFromDraft();
      });
    });

    bannerCambiar.addEventListener('click', () => {
      seleccionActual = null;
      tipoBtns.forEach(b => b.classList.remove('selected', 'desactivado'));
      btnSiguiente.disabled = true;
      btnFinalizar.disabled = true;
      banner.hidden = true;
      setDraft('cupla_status', undefined);
      syncTubeFromDraft();
    });

    // --- EL TRIGGER DEL TIEMPO REAL ---
    btnSiguiente.addEventListener('click', async () => {
      if (!seleccionActual) return;
      
      const itv = loadIntervencion();
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      
      // Datos completos del tubo (unimos el draft con la cupla recién elegida)
      const dataTubo = { ...itv.draft, cupla_status: seleccionActual };

      // 1) Guardamos localmente para el operador (tu lógica)
      if (tubes[idx]) tubes[idx].completedAt = new Date().toISOString();
      saveTubes(tubes);

      // 2) SUBIMOS A FIREBASE PARA EL JEFE (Nueva lógica)
      btnSiguiente.disabled = true;
      btnSiguiente.textContent = "Sincronizando...";
      await guardarTuboEnVivo(itv, dataTubo);

      // 3) Avanzamos (tu lógica)
      itv.tuboActual = Number(itv.tuboActual) + 1;
      itv.draft = {}; 
      saveIntervencion(itv);
      window.location.href = 'Desgaste.html';
    });

    btnFinalizar.addEventListener('click', async () => {
      if (!seleccionActual) return;
      const itv = loadIntervencion();
      const dataTubo = { ...itv.draft, cupla_status: seleccionActual };
      
      btnFinalizar.disabled = true;
      btnFinalizar.textContent = "Finalizando...";
      
      // Marcamos como finalizada en Firebase para que el jefe sepa que terminó
      await guardarTuboEnVivo(itv, dataTubo, true);
      
      window.location.href = 'findelproceso.html';
    });
  </script>
</body>
</html>