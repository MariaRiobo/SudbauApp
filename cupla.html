<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cupla</title>
  <link rel="stylesheet" href="css/app.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .tipo-btn.selected { outline: 3px solid rgba(0,85,170,.25); transform: translateY(1px); }
    .tipo-btn.desactivado { pointer-events: none; filter: grayscale(100%); opacity: .5; }

    .seleccion-banner {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; padding: 10px 14px; border-radius: 10px; margin: 10px 0 8px;
      background: #E9F3FF; font-family: 'Noto Sans', sans-serif; font-size: 14px;
    }
    .seleccion-banner[hidden]{ display:none; }
    .seleccion-banner button {
      background: transparent; border: 0; text-decoration: underline; cursor: pointer;
      font-family: 'Kanit', sans-serif; font-size: 14px;
    }

    .btn:disabled,
    .btn[disabled],
    #btn-siguiente-tubo:disabled,
    #btn-finalizar:disabled {
      opacity: 0.5;
      filter: grayscale(100%);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn:disabled:hover,
    .btn:disabled:focus { box-shadow: none; outline: none; }
  </style>
</head>

<body>
  <div class="container container-large container-wide">
    <div class="header-corrosion">
      <div class="header-left">
        <img src="img/logo.png" alt="Logo de la empresa" class="logo">
        <div class="titulo-y-tubo">
          <p class="subtitulo-tubo">Tubo Nº <span id="numero-tubo"></span></p>
          <h1 class="title">CUPLA</h1>
        </div>
      </div>
    </div>

    <div class="tipo-container">
      <div class="tipo-item">
        <a href="" class="tipo-btn" data-code="buena">BUENA</a>
        <p>Cupla buena</p>
      </div>
      <div class="tipo-item">
        <a href="" class="tipo-btn" data-code="defectuosa">DEFECTUOSA</a>
        <p>Cupla defectuosa</p>
      </div>
    </div>

    <div id="seleccion-banner" class="seleccion-banner" hidden aria-live="polite">
      <span id="seleccion-texto"></span>
      <button id="seleccion-cambiar" type="button">Cambiar</button>
    </div>

    <div class="controles" id="controles-cta">
      <a href="./tipo.html" class="btn-volver">Atrás</a>
      <button id="btn-siguiente-tubo" class="btn" disabled>Siguiente tubo</button>
    </div>
    <div class="controles">
      <button id="btn-finalizar" class="btn btn-danger" disabled>Finalizar inspección</button>
    </div>
  </div>

  <script>
    /* ===== Helpers de estado ===== */
    function loadIntervencion() {
      const raw = localStorage.getItem('intervencionActual');
      if (!raw) { window.location.href = 'InicioSesion.html'; return null; }
      const itv = JSON.parse(raw);
      if (!itv.draft) itv.draft = {};
      if (!itv.registros) itv.registros = [];
      if (!itv.eventos) itv.eventos = [];
      return itv;
    }
    function saveIntervencion(itv){ localStorage.setItem('intervencionActual', JSON.stringify(itv)); }
    function setDraft(field, value){
      const itv = loadIntervencion(); if (!itv) return;
      if (value === undefined) delete itv.draft[field]; else itv.draft[field] = value;
      saveIntervencion(itv);
    }
    function pushEvento(tipo, extra = {}) {
      const itv = loadIntervencion(); if (!itv) return;
      itv.eventos.push({ tipo, tubo: Number(itv.tuboActual), at: new Date().toISOString(), ...extra });
      saveIntervencion(itv);
    }

    /* ===== Helpers para tubos[] ===== */
    function loadTubes(){ return JSON.parse(localStorage.getItem('tubos') || '[]'); }
    function saveTubes(arr){ localStorage.setItem('tubos', JSON.stringify(arr)); }
    function ensureTubeIndex(tubes, idx){
      while (tubes.length <= idx) tubes.push({ nro: tubes.length + 1, draft: {}, completedAt: null });
      return tubes[idx];
    }
    function currentTubeIndex(itv){ return Number(itv.tuboActual || 1) - 1; }

    function syncDraftFromTube(){
      const itv = loadIntervencion(); if (!itv) return;
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      const t = ensureTubeIndex(tubes, idx);
      itv.draft = { ...(t.draft||{}), ...(itv.draft||{}) };
      saveIntervencion(itv);
    }
    function syncTubeFromDraft(){
      const itv = loadIntervencion(); if (!itv) return;
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      const t = ensureTubeIndex(tubes, idx);
      t.draft = { ...(t.draft||{}), ...(itv.draft||{}) };
      saveTubes(tubes);
    }

    function isEditMode(){ return localStorage.getItem('editMode') === 'true'; }
    function clearEditMode(){
      localStorage.setItem('editMode','false');
      localStorage.removeItem('editTubeIndex');
    }

    /* ===== UI init ===== */
    const itvInit = loadIntervencion();
    const tuboSpan = document.getElementById('numero-tubo');
    if (itvInit && tuboSpan) tuboSpan.textContent = itvInit.tuboActual;

    // NUEVO: si venís a editar, precargá el draft del tubo
    if (itvInit) syncDraftFromTube();

    const tipoBtns = document.querySelectorAll('.tipo-btn');
    const btnSiguiente = document.getElementById('btn-siguiente-tubo');
    const btnFinalizar = document.getElementById('btn-finalizar');
    const banner = document.getElementById('seleccion-banner');
    const bannerTexto = document.getElementById('seleccion-texto');
    const bannerCambiar = document.getElementById('seleccion-cambiar');

    let seleccionActual = null;

    btnSiguiente.disabled = true;
    btnFinalizar.disabled = true;

    // Click en BUENA / DEFECTUOSA
    tipoBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        seleccionActual = btn.dataset.code;

        tipoBtns.forEach(b => (b === btn) ? b.classList.add('selected') : b.classList.add('desactivado'));

        btnSiguiente.disabled = false;
        btnFinalizar.disabled = false;

        const textoHumano = (seleccionActual === 'buena') ? 'CUPLA BUENA' : 'CUPLA DEFECTUOSA';
        bannerTexto.textContent = `Seleccionaste: ${textoHumano}`;
        banner.hidden = false;

        // Guardado en draft + sync a tubos
        setDraft('cupla_status', seleccionActual);
        syncTubeFromDraft();

        pushEvento('cuplaSeleccionada', { cupla_status: seleccionActual });

        const target = document.getElementById('controles-cta');
        if (target) {
          const y = target.getBoundingClientRect().top + window.pageYOffset - 80;
          window.scrollTo({ top: y, behavior: 'smooth' });
        }
      });
    });

    // Cambiar selección
    bannerCambiar.addEventListener('click', () => {
      seleccionActual = null;
      tipoBtns.forEach(b => b.classList.remove('selected', 'desactivado'));
      btnSiguiente.disabled = true;
      btnFinalizar.disabled = true;
      banner.hidden = true;
      setDraft('cupla_status', undefined);
      syncTubeFromDraft();
    });

    // Si ya venía seleccionado (modo edición), pre-seleccionar
    const itvPrefill = loadIntervencion();
    if (itvPrefill && itvPrefill.draft && itvPrefill.draft.cupla_status) {
      const val = itvPrefill.draft.cupla_status;
      const btn = Array.from(tipoBtns).find(b => b.dataset.code === val);
      if (btn) btn.click();
    }

    // Siguiente tubo
    btnSiguiente.addEventListener('click', () => {
      if (!seleccionActual) return;

      pushEvento('tuboCerrado', { cupla_status: seleccionActual });

      // marcar completado en tubos[]
      const itv = loadIntervencion(); if (!itv) return;
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      const t = ensureTubeIndex(tubes, idx);
      t.completedAt = new Date().toISOString();
      saveTubes(tubes);

      if (isEditMode()) {
        // editando un tubo viejo -> volver al fin del proceso
        clearEditMode();
        itv.draft = {};
        saveIntervencion(itv);
        window.location.href = (localStorage.getItem('lastPage') || 'findelproceso.html');
        return;
      }

      // flujo normal -> avanzar
      itv.tuboActual = Number(itv.tuboActual || 0) + 1;
      itv.draft = {};
      saveIntervencion(itv);

      window.location.href = 'Desgaste.html';
    });

    // Finalizar inspección -> ir a findelproceso.html
    btnFinalizar.addEventListener('click', () => {
      if (!seleccionActual) return;

      const itv = loadIntervencion(); if (!itv) return;

      // marcar completado en tubos[]
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      const t = ensureTubeIndex(tubes, idx);
      t.completedAt = new Date().toISOString();
      saveTubes(tubes);

      clearEditMode();
      itv.draft = {};
      saveIntervencion(itv);

      window.location.href = 'findelproceso.html';
    });
  </script>
</body>
</html>
