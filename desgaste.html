<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Desgaste</title>

  <meta name="theme-color" content="#0055AA">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Sudbaü App: Modo Operador Activo'))
          .catch(err => console.log('Error al registrar Service Worker', err));
      });
    }
  </script>
  
  <link rel="stylesheet" href="css/app.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

  <style>
    .desactivado, .desactivado:focus, .desactivado:hover {
      pointer-events: none;
      opacity: .5;
      cursor: not-allowed !important;
      filter: grayscale(20%);
    }
    .justificacion-container{
      margin-top: 16px;
      padding: 12px;
      border: 1px solid #CDCDDC;
      border-radius: 10px;
      background: #fff;
    }
    .justificacion-container input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #0055AA;
      border-radius: 10px;
      font-family: "Noto Sans", sans-serif;
      font-size: 14px;
      text-transform: uppercase;
      box-sizing:border-box;
    }
    .justificacion-container textarea{
      width: 100%;
      min-height: 96px;
      padding: 10px 12px;
      border: 1px solid #0055AA;
      border-radius: 10px;
      font-family: "Noto Sans", sans-serif;
      font-size: 14px;
      resize: vertical;
      text-transform: uppercase;
      box-sizing: border-box;
      margin-top: 10px;
    }
    .btn-justificar:disabled{
      opacity: .5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn-justificar.success {
      background-color: #28a745 !important;
      color: white !important;
      border: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header-corrosion">
      <div class="header-left">
        <img src="img/logo.png" alt="Logo de la empresa" class="logo">
        <div class="titulo-y-tubo">
          <p class="subtitulo-tubo">Tubo Nº <span id="numero-tubo"></span></p>
          <h1 class="title">DESGASTE</h1>
        </div>
      </div>
    </div>

    <div class="botones-container">
      <a href="Corrosion.html" class="btn-color amarillo">G2</a>
      <a href="Corrosion.html" class="btn-color azul">G3</a>
      <a href="Corrosion.html" class="btn-color verde">G4</a>
      <a href="Corrosion.html" class="btn-color rojo">G5</a>
      <a href="Corrosion.html" class="btn-color blanco">UNGRADE</a>
    </div>

    <div class="controles">
      <button type="button" class="btn-volver">Volver</button>
      <button class="btn-parada">Parada</button>
    </div>

    <div class="justificacion-container" style="display:none;">
      <p>Fecha y hora: <span id="fecha-hora"></span></p>

      <label for="justificacion_lista">Justificación:</label>

      <input
        type="text"
        id="justificacion_lista"
        list="justificaciones_opciones"
        placeholder="Seleccionar o escribir motivo..."
        autocomplete="off"
      >

      <datalist id="justificaciones_opciones">
        <option value="ESPERA POR MANIOBRAS">
        <option value="MONTAJE DE EQUIPO SCANNEX">
        <option value="MONTAJE DE EQUIPO RODDEX">
        <option value="COMIENZA INSPECCIÓN DE TBG">
        <option value="SE RETOMA INSPECCIÓN DE TBG">
        <option value="SE RETOMA INSPECCIÓN DE VB">
        <option value="COMIENZA INSPECCIÓN DE VB">
        <option value="FINALIZA INSPECCIÓN DE TBG">
        <option value="FINALIZA INSPECCIÓN DE VB">
        <option value="SE DESMONTA EQUIPO DE SCANNEX">
        <option value="SE DESMONTA EQUIPO DE RODDEX">
        <option value="SE DETIENE INSPECCIÓN POR PROBLEMAS CLIMÁTICOS">
        <option value="AVISO DE SUSPENSIÓN DE SERVICIO">
        <option value="PRUEBA DE EQUIPO">
        <option value="CALIBRACIÓN DE EQUIPO">
        <option value="SE DETIENE INSPECCIÓN POR CAMBIO DE TURNO">
        <option value="SE DETIENE INSPECCIÓN POR PROBLEMAS CON EQUIPO">
        <option value="SE DETIENE INSPECCIÓN POR MANIOBRA DE EQUIPO">
        <option value="SE DETIENE INSPECCIÓN POR ORDEN DEL COMPANY">
        <option value="ESPERA POR FUERTES VIENTOS">
        <option value="SE SUSPENDE POR ASAMBLEA GREMIAL">
        <option value="SE DETIENE INSPECCIÓN POR ASAMBLEA GREMIAL">
        <option value="SE DETIENE INSPECCIÓN POR CAPACITACIONES DE SEGURIDAD">
        <option value="SE JUNTAN HERRAMIENTAS DE TRABAJO">
        <option value="ESPERA PARA INGRESAR A REALIZAR EL MONTAJE DEL EQUIPO DE INSPECCIÓN">
        <option value="MONTAJE Y CALIBRACIÓN DE EQUIPO">
        <option value="ESPERA EN DEPARTAMENTO">
        <option value="VIAJE DE DEPARTAMENTO A LOCACIÓN">
        <option value="VIAJE DE LOCACIÓN A DEPARTAMENTO">
        <option value="ESPERA POR FALLA DE EQUIPO DE PULLING">
        <option value="ESPERA POR FALLA DE EQUIPO SCANNEX">
        <option value="DESCANSO EN DEPARTAMENTO">
        <option value="SE DETIENE INSPECCIÓN POR SITUACIÓN DE EMERGENCIA">
        <option value="OTROS">
      </datalist>

      <textarea id="justificacion_otros" rows="4" placeholder="DETALLAR OTRO MOTIVO" style="display:none;"></textarea>
      <button class="btn-justificar" disabled>Justificar</button>
    </div>

    <button class="btn-arranque" style="display:none;">Arranque</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMeOkD8NMaPwVRGqeQxqnrpnwPfjwjiuw",
      authDomain: "sudbau-app.firebaseapp.com",
      projectId: "sudbau-app",
      storageBucket: "sudbau-app.firebasestorage.app",
      messagingSenderId: "803219965094",
      appId: "1:803219965094:web:121e2ed15d663225202067"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ===== Local Storage Helpers ===== */
    function loadIntervencion() {
      const raw = localStorage.getItem('intervencionActual');
      if (!raw) { window.location.href = 'InicioSesion.html'; return null; }
      const itv = JSON.parse(raw);
      if (!itv.draft) itv.draft = {};
      if (!itv.eventos) itv.eventos = [];
      return itv;
    }
    function saveIntervencion(itv) {
      localStorage.setItem('intervencionActual', JSON.stringify(itv));
    }
    function pushEvento(tipo, extra = {}) {
      const itv = loadIntervencion(); if (!itv) return;
      itv.eventos.push({
        tipo,
        tubo: Number(itv.tuboActual),
        at: new Date().toISOString(),
        ...extra
      });
      saveIntervencion(itv);
    }

    /* ===== Tubos helpers ===== */
    function loadTubes() {
      return JSON.parse(localStorage.getItem('tubos') || '[]');
    }
    function saveTubes(arr) {
      localStorage.setItem('tubos', JSON.stringify(arr));
    }
    function ensureTubeIndex(tubes, idx) {
      while (tubes.length <= idx) {
        tubes.push({ nro: tubes.length + 1, draft: {}, completedAt: null });
      }
      return tubes[idx];
    }
    function currentTubeIndex(itv) {
      return Number(itv.tuboActual || 1) - 1;
    }
    function getCurrentTube() {
      const itv = loadIntervencion(); if (!itv) return null;
      const tubes = loadTubes();
      const idx = currentTubeIndex(itv);
      const t = ensureTubeIndex(tubes, idx);
      return { itv, tubes, idx, t };
    }
    function syncDraftFromTube() {
      const pack = getCurrentTube(); if (!pack) return;
      const { itv, t } = pack;
      itv.draft = { ...(t.draft || {}), ...(itv.draft || {}) };
      saveIntervencion(itv);
    }
    function syncTubeFromDraft() {
      const pack = getCurrentTube(); if (!pack) return;
      const { tubes, idx, t, itv } = pack;
      t.draft = { ...(t.draft || {}), ...(itv.draft || {}) };
      tubes[idx] = t;
      saveTubes(tubes);
    }

    /* ===== Inicialización ===== */
    const itv = loadIntervencion();
    const numeroTuboSpan = document.getElementById('numero-tubo');
    if (itv && numeroTuboSpan) numeroTuboSpan.textContent = itv.tuboActual;

    if (itv) syncDraftFromTube();

    const justificacionContainer = document.querySelector('.justificacion-container');
    const btnParada = document.querySelector('.btn-parada');
    const btnArranque = document.querySelector('.btn-arranque');
    const fechaHoraSpan = document.getElementById('fecha-hora');
    const btnJustificar = document.querySelector('.btn-justificar');
    const botonesColor = document.querySelectorAll('.btn-color');
    const btnVolver = document.querySelector('.btn-volver');

    const listaJustificacion = document.getElementById('justificacion_lista');
    const txtJustificacionOtros = document.getElementById('justificacion_otros');

    /* ===== Parada / Justificar / Arranque ===== */
    btnParada.addEventListener('click', () => {
      const now = new Date();
      fechaHoraSpan.textContent = now.toLocaleString();

      justificacionContainer.style.display = 'block';

      botonesColor.forEach(btn => btn.classList.add('desactivado'));
      btnVolver.classList.add('desactivado');
      btnVolver.setAttribute('aria-disabled', 'true');

      btnParada.disabled = true;
      btnJustificar.disabled = true;
      
      btnJustificar.textContent = "Justificar";
      btnJustificar.classList.remove('success');

      pushEvento('parada');

      const pack = getCurrentTube();
      if (pack) {
        const { tubes, idx, t } = pack;
        t.draft = t.draft || {};
        t.draft.paradaAt = now.toISOString();
        tubes[idx] = t;
        saveTubes(tubes);
      }
    });

    // CAMBIO AQUÍ: Botón volver con ruta absoluta para evitar 404
    btnVolver.addEventListener('click', (e) => {
      if (btnVolver.classList.contains('desactivado')) {
        e.preventDefault();
        return;
      }
      const itv = loadIntervencion();
      if (!itv) return;

      const actual = Number(itv.tuboActual || 1);
      const anterior = actual - 1;

      if (anterior < 1) {
        alert('Ya estás en el primer tubo. No se puede retroceder más.');
        return;
      }
      const confirmar = confirm(`Vas a volver al tubo anterior (Tubo Nº ${anterior}). ¿Querés continuar?`);
      if (!confirmar) return;

      itv.tuboActual = anterior;
      saveIntervencion(itv);
      pushEvento('volverACupla', { tuboDestino: anterior });

      // Ruta absoluta y timestamp para cache
      window.location.href = '/cupla.html?v=' + Date.now();
    });

    function forceUppercase(e) {
      const upper = e.target.value.toUpperCase();
      if (e.target.value !== upper) {
        const selStart = e.target.selectionStart;
        const selEnd = e.target.selectionEnd;
        e.target.value = upper;
        e.target.setSelectionRange(selStart, selEnd);
      }
      return upper;
    }

    function updateJustificarState() {
      if (btnJustificar.classList.contains('success')) return;

      const listaVal = listaJustificacion.value.trim().toUpperCase();

      if (listaVal === 'OTROS') {
        txtJustificacionOtros.style.display = 'block';
        const otrosVal = txtJustificacionOtros.value.trim().toUpperCase();
        btnJustificar.disabled = otrosVal.length === 0;
      } else {
        txtJustificacionOtros.style.display = 'none';
        txtJustificacionOtros.value = '';
        btnJustificar.disabled = listaVal.length === 0;
      }
    }

    listaJustificacion.addEventListener('input', (e) => {
      forceUppercase(e);
      updateJustificarState();
    });

    txtJustificacionOtros.addEventListener('input', (e) => {
      forceUppercase(e);
      updateJustificarState();
    });

    btnJustificar.addEventListener('click', async () => {
      const listaVal = listaJustificacion.value.trim().toUpperCase();
      let justificacionFinal = '';

      if (listaVal === 'OTROS') {
        justificacionFinal = txtJustificacionOtros.value.trim().toUpperCase();
      } else {
        justificacionFinal = listaVal;
      }
      if (!justificacionFinal) return;

      const guardado = `STANDBY - ${justificacionFinal}`;

      btnArranque.style.display = 'block';
      btnJustificar.disabled = true;
      btnJustificar.textContent = "JUSTIFICADO ✅";
      btnJustificar.classList.add('success');

      pushEvento('justificacion', { texto: guardado });

      const pack = getCurrentTube();
      if (pack) {
        const { tubes, idx, t, itv } = pack;
        t.draft = t.draft || {};
        t.draft.justificacion = guardado;
        tubes[idx] = t;
        saveTubes(tubes);

        if (itv.id) {
          try {
            const docRef = doc(db, "inspecciones_live", itv.id);
            await updateDoc(docRef, {
              paradaAt: t.draft.paradaAt,
              justificacion: guardado,
              arranqueAt: null,
              tubos: tubes
            });
          } catch (error) { console.error("Error al subir a Firebase:", error); }
        }
      }

      alert("✅ Justificación guardada. Ahora puede presionar el botón de ARRANQUE.");
    });

    btnArranque.addEventListener('click', async () => {
      const now = new Date();
      const itv_actual = loadIntervencion();

      botonesColor.forEach(btn => btn.classList.remove('desactivado'));
      btnVolver.classList.remove('desactivado');
      btnVolver.removeAttribute('aria-disabled');

      justificacionContainer.style.display = 'none';
      btnArranque.style.display = 'none';
      btnParada.disabled = false;

      listaJustificacion.value = '';
      txtJustificacionOtros.value = '';
      txtJustificacionOtros.style.display = 'none';
      
      btnJustificar.disabled = true;
      btnJustificar.textContent = "Justificar";
      btnJustificar.classList.remove('success');

      pushEvento('arranque');

      const pack = getCurrentTube();
      if (pack) {
        const { tubes, idx, t } = pack;
        t.draft = t.draft || {};
        t.draft.arranqueAt = now.toISOString();
        tubes[idx] = t;
        saveTubes(tubes);

        if (itv_actual.id) {
          try {
            const docRef = doc(db, "inspecciones_live", itv_actual.id);
            await updateDoc(docRef, {
              arranqueAt: now.toISOString(),
              tubos: tubes
            });
          } catch (error) { console.error("Error al subir arranque:", error); }
        }
      }
    });

    const DESGASTE_MAP = {
      amarillo: 'G2',
      azul: 'G3',
      verde: 'G4',
      rojo: 'G5',
      blanco: 'UNGRADE'
    };

    document.querySelectorAll('.botones-container .btn-color').forEach(a => {
      a.addEventListener('click', (e) => {
        if (a.classList.contains('desactivado')) { e.preventDefault(); return; }
        e.preventDefault();

        const cls = e.currentTarget.className.split(/\s+/);
        const color = Object.keys(DESGASTE_MAP).find(c => cls.includes(c));
        const desgaste = DESGASTE_MAP[color] || 'UNGRADE';

        const itv2 = loadIntervencion();
        if (!itv2) return;

        itv2.draft.desgaste = desgaste;
        saveIntervencion(itv2);
        syncTubeFromDraft();
        pushEvento('desgasteSeleccionado', { desgaste });

        // CAMBIO AQUÍ: Minúscula para evitar 404
        window.location.href = 'Corrosion.html';
      });
    });
  </script>
</body>
</html>