<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fin del proceso</title>

  <meta name="theme-color" content="#0055AA">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Sudbaü App: Modo Operador Activo'))
          .catch(err => console.log('Error al registrar Service Worker', err));
      });
    }
  </script>
  
  <link rel="stylesheet" href="css/app.css">

  <style>
    .card{
      background:#fff;
      border:1px solid #CDCDDC;
      border-radius:12px;
      padding:14px;
      margin:12px 0;
    }
    .hint{
      font-size:13px;
      color:#05145A;
      margin-top:6px;
    }
    label{ display:block; margin-bottom:6px; }
    select{
      width:100%;
      padding:10px 12px;
      border:1px solid #0055AA;
      border-radius:10px;
      box-sizing:border-box;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .row .btn{ flex:1; }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      filter:grayscale(100%);
      box-shadow:none;
      transform:none;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMeOkD8NMaPwVRGqeQxqnrpnwPfjwjiuw",
      authDomain: "sudbau-app.firebaseapp.com",
      projectId: "sudbau-app",
      storageBucket: "sudbau-app.firebasestorage.app",
      messagingSenderId: "803219965094",
      appId: "1:803219965094:web:121e2ed15d663225202067",
      measurementId: "G-8XY511E3JL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.SUDBAU_DB = db;
  </script>
</head>

<body>
  <div class="container">
    <div class="header header-login">
      <img src="img/logoHorizontal.png" alt="Logo de la empresa" class="logo" />
      <h1 class="title">Fin del proceso</h1>
    </div>

    <div class="card" id="resumen"></div>

    <div class="card">
      <label for="editSelect">¿Querés editar algún tubo anterior?</label>
      <select id="editSelect">
        <option value="">— Elegí un tubo —</option>
      </select>
      <div class="hint">Tip: si la máquina devolvió el dato tarde, elegí el tubo y tocá “Editar”.</div>

      <div class="row">
        <button class="btn" id="btnEditar" disabled>Editar</button>
        <button class="btn btn-danger" id="btnCerrar">Finalizar definitivamente</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================================================
      ❌ SHEETBEST DESACTIVADO (PRUEBA FINALIZADA)
    ========================================================= */
    const SHEETBEST_URL = ""; 

    /* ===== LocalStorage helpers ===== */
    function loadIntervencion() {
      const raw = localStorage.getItem('intervencionActual');
      if (!raw) { window.location.href = 'InicioSesion.html'; return null; }
      return JSON.parse(raw);
    }
    function saveIntervencion(itv){
      localStorage.setItem('intervencionActual', JSON.stringify(itv));
    }
    function loadTubes(){
      return JSON.parse(localStorage.getItem('tubos') || '[]');
    }
    function saveTubes(arr){
      localStorage.setItem('tubos', JSON.stringify(arr));
    }

    const itv = loadIntervencion();
    const tubos = loadTubes();

    // ===== Resumen =====
    const resumen = document.getElementById('resumen');
    if (itv && resumen) {
      resumen.innerHTML = `
        <b>${itv.cliente || ''}</b><br>
        Área: ${itv.area || ''}<br>
        Pozo: ${itv.pozo || ''}<br>
        OT: ${itv.ot || ''}<br>
        Operador: ${itv.operador || ''}<br>
        Ayudante: ${itv.ayudante || ''}<br>
        Solicitado: ${itv.solicitado || ''}<br>
        <br>
        Tubos registrados: <b>${tubos.length}</b>
      `;
    }

    // ===== Dropdown de tubos =====
    const sel = document.getElementById('editSelect');
    const btnEditar = document.getElementById('btnEditar');

    tubos.forEach((t, i) => {
      const opt = document.createElement('option');
      const estado = t.completedAt ? 'OK' : 'INCOMPLETO';
      opt.value = String(i);
      opt.textContent = `Tubo ${t.nro} — ${estado}`;
      sel.appendChild(opt);
    });

    sel.addEventListener('change', () => {
      btnEditar.disabled = (sel.value === "");
    });

    // ===== Editar tubo =====
    btnEditar.addEventListener('click', () => {
      if (sel.value === "") return;

      const idx = Number(sel.value);
      const t = tubos[idx];

      localStorage.setItem('editMode', 'true');
      localStorage.setItem('editTubeIndex', String(idx));
      localStorage.setItem('lastPage', 'findeproceso.html');

      const itv2 = loadIntervencion();
      itv2.tuboActual = idx + 1;
      itv2.draft = (t && t.draft) ? { ...t.draft } : {};
      saveIntervencion(itv2);

      window.location.href = 'desgaste.html';
    });

    /* =========================================================
      ✅ Firestore
    ========================================================= */
    async function guardarEnFirestore(payload, docIdAmigable) {
      const { doc, setDoc, collection, serverTimestamp } = await import(
        "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js"
      );

      const db = window.SUDBAU_DB;
      if (!db) throw new Error("Firestore no inicializado");

      const ref = doc(collection(db, "inspecciones"), docIdAmigable);

      await setDoc(ref, {
        ...payload,
        createdAt: serverTimestamp(),
        estado: "FINALIZADA" // Marcamos como finalizada
      });

      return ref.id;
    }

    function generarIdAmigable() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      const ss = String(d.getSeconds()).padStart(2, '0');
      return `SUD-${y}${m}${day}-${hh}${mm}${ss}`;
    }

    // ===== Finalizar definitivamente (SOLO FIREBASE) =====
    document.getElementById('btnCerrar').addEventListener('click', async () => {
      const ok = confirm('¿Finalizar definitivamente? Esto guardará la intervención en Firebase y la cerrará.');
      if (!ok) return;

      const btnCerrar = document.getElementById('btnCerrar');
      btnCerrar.disabled = true;

      try {
        const itvGuardada = JSON.parse(localStorage.getItem('intervencionActual') || 'null');
        const tubosGuardados = JSON.parse(localStorage.getItem('tubos') || '[]');
        if (!itvGuardada) throw new Error("No hay datos en el teléfono");

        const payload = {
          cliente: itvGuardada.cliente || "",
          area: itvGuardada.area || "",
          pozo: itvGuardada.pozo || "",
          ot: itvGuardada.ot || "",
          operador: itvGuardada.operador || "",
          ayudante: itvGuardada.ayudante || "",
          solicitado: itvGuardada.solicitado || "",
          tubosCount: Array.isArray(tubosGuardados) ? tubosGuardados.length : 0,
          intervencion: itvGuardada,
          tubos: tubosGuardados
        };

        const docId = generarIdAmigable();

        // 1) Guardar en Firestore (Colección "inspecciones")
        await guardarEnFirestore(payload, docId);

        alert("✅ Inspección finalizada con éxito en Firebase. ID: " + docId);

        // 2) Limpiar localStorage
        localStorage.removeItem('intervencionActual');
        localStorage.removeItem('tubos');
        localStorage.removeItem('editMode');
        localStorage.removeItem('editTubeIndex');
        localStorage.removeItem('lastPage');

        window.location.href = 'InicioSesion.html';
      } catch (e) {
        console.error(e);
        btnCerrar.disabled = false;
        alert("❌ Error: " + e.message);
      }
    });
  </script>
</body>
</html>