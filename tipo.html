<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tipo de Tubo</title>

  <meta name="theme-color" content="#0055AA">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Sudbaü App: Modo Operador Activo'))
          .catch(err => console.log('Error al registrar Service Worker', err));
      });
    }
  </script>

  <link rel="stylesheet" href="css/app.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* ===== ESTILOS IDÉNTICOS A CUPLA ===== */
    .tipo-btn {
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      transition: all 0.2s ease;
      font-family: 'Kanit', sans-serif;
      font-weight: 500;
    }

    .tipo-btn.selected { 
      outline: 3px solid rgba(0,85,170,.25); 
      transform: translateY(1px); 
      background-color: #0055AA !important; 
      color: white !important; 
      border-color: #0055AA !important;
    }
    
    .seleccion-banner {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; padding: 10px 14px; border-radius: 10px; margin: 10px 0 8px;
      background: #E9F3FF; font-family: 'Noto Sans', sans-serif; font-size: 14px;
      color: #05145A;
    }
    .seleccion-banner[hidden]{ display:none; }
    .seleccion-banner button {
      background: transparent; border: 0; text-decoration: underline; cursor: pointer;
      font-family: 'Kanit', sans-serif; font-size: 14px; color: #0055AA;
    }

    .btn:disabled, .btn[disabled] {
      opacity: 0.5;
      filter: grayscale(100%);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .controles {
      display: flex;
      gap: 12px;
      margin-top: 10px;
    }
    .btn-volver { flex: 1; text-align: center; }
    .btn-siguiente { flex: 1; }
  </style>
</head>

<body>
  <div class="container container-large container-wide">

    <div class="header-corrosion">
       <div class="header-left">
        <img src="img/logo.png" alt="Logo de la empresa" class="logo">
         <div class="titulo-y-tubo">
          <p class="subtitulo-tubo">Tubo Nº <span id="numero-tubo"></span></p>
           <h1 class="title">TIPO</h1>
        </div>
       </div>
     </div>

     <div class="tipo-container">
      <div class="tipo-item"><div class="tipo-btn" data-code="CO">CO</div><p>Corrosión</p></div>
      <div class="tipo-item"><div class="tipo-btn" data-code="DG">DG</div><p>Desgaste general</p></div>
      <div class="tipo-item"><div class="tipo-btn" data-code="DC">DC</div><p>Desgaste cuña/contra</p></div>
      <div class="tipo-item"><div class="tipo-btn" data-code="DP">DP</div><p>Desgaste puntual</p></div>
      <div class="tipo-item"><div class="tipo-btn" data-code="TR">TR</div><p>Tubing roto</p></div>
      <div class="tipo-item"><div class="tipo-btn" data-code="TT">TT</div><p>Tubing torcido</p></div>
      <div class="tipo-item"><div class="tipo-btn" data-code="TP">TP</div><p>Tubing pinchado</p></div>
      <div class="tipo-item"><div class="tipo-btn" data-code="RV">RV</div><p>Rozamiento de varilla</p></div>
      <div class="tipo-item tipo-span-2"><div class="tipo-btn" data-code="UG">UG</div><p>Ungraded</p></div>
    </div>
 
    <div id="seleccion-banner" class="seleccion-banner" hidden aria-live="polite">
      <span id="seleccion-texto"></span>
      <button id="seleccion-cambiar" type="button">Limpiar</button>
    </div>

    <div class="controles">
      <button type="button" id="btnVolverAtras" class="btn-volver">Atrás</button>
      <button type="button" id="btnSiguiente" class="btn btn-siguiente" disabled>Siguiente</button>
    </div>
   </div>

   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, enableIndexedDbPersistence, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMeOkD8NMaPwVRGqeQxqnrpnwPfjwjiuw",
      authDomain: "sudbau-app.firebaseapp.com",
      projectId: "sudbau-app",
      storageBucket: "sudbau-app.firebasestorage.app",
      messagingSenderId: "803219965094",
      appId: "1:803219965094:web:121e2ed15d663225202067"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // PERSISTENCIA OFFLINE
    enableIndexedDbPersistence(db).catch(() => console.warn("Modo offline activo en Tipo"));

    /* ===== Local Storage Helpers ===== */
     function loadIntervencion() {
       const raw = localStorage.getItem('intervencionActual');
       if (!raw) { window.location.href = 'InicioSesion.html'; return null; }
       const itv = JSON.parse(raw);
       if (!itv.draft) itv.draft = {};
       if (!itv.eventos) itv.eventos = [];
      return itv;
     }
    function saveIntervencion(itv) { localStorage.setItem('intervencionActual', JSON.stringify(itv)); }
    
    function pushEvento(tipo, extra = {}) {
      const itv = loadIntervencion(); if (!itv) return;
       itv.eventos.push({
        tipo,
        tubo: Number(itv.tuboActual),
        at: new Date().toISOString(),
         ...extra
      });
       saveIntervencion(itv);
    }
 
    /* ===== Helpers Tubos ===== */
     function loadTubes(){ return JSON.parse(localStorage.getItem('tubos') || '[]'); }
     function saveTubes(arr){ localStorage.setItem('tubos', JSON.stringify(arr)); }
     function ensureTubeIndex(tubes, idx){
       while (tubes.length <= idx) tubes.push({ nro: tubes.length + 1, draft: {}, completedAt: null });
       return tubes[idx];
    }
     function currentTubeIndex(itv){ return Number(itv.tuboActual || 1) - 1; }

     function syncDraftFromTube(){
       const itv = loadIntervencion(); if (!itv) return;
       const tubes = loadTubes();
       const idx = currentTubeIndex(itv);
       const t = ensureTubeIndex(tubes, idx);
       itv.draft = { ...(t.draft||{}), ...(itv.draft||{}) };
       saveIntervencion(itv);
     }
     function syncTubeFromDraft(){
       const itv = loadIntervencion(); if (!itv) return;
       const tubes = loadTubes();
       const idx = currentTubeIndex(itv);
       const t = ensureTubeIndex(tubes, idx);
       t.draft = { ...(t.draft||{}), ...(itv.draft||{}) };
       saveTubes(tubes);
     }

     /* ===== Init ===== */
     const itvInit = loadIntervencion();
     if (itvInit) {
      syncDraftFromTube(); 
       const numeroTuboSpan = document.getElementById('numero-tubo');
      if (numeroTuboSpan) numeroTuboSpan.textContent = itvInit.tuboActual;
     }

    // ==========================================
    // SINCRONIZADOR SILENCIOSO DE FONDO
    // ==========================================
    function sincronizarLiveDeFondo() {
      const itv = loadIntervencion();
      const tubos = loadTubes();
      if (!itv) return;

      const idFirebase = itv.customId || itv.liveId;
      if (!idFirebase) return;

      // 1. Guardar la cabecera (incluyendo el borrador actual)
      const headerRef = doc(db, "inspecciones_live", idFirebase);
      setDoc(headerRef, {
        cliente: itv.cliente || "",
        pozo: itv.pozo || "",
        ot: itv.ot || "",
        tuboActual: Number(itv.tuboActual),
        ultimo_draft: itv.draft || {},
        lastUpdateAt: serverTimestamp(),
        estado: "EN_PROCESO"
      }, { merge: true }).catch(() => {});

      // 2. Revisamos los ÚLTIMOS 10 TUBOS y los subimos por si faltó alguno.
      tubos.forEach(t => {
        const d = t.draft || t;
        const nroTubo = String(t.nro || d.tuboNro);
        if (!nroTubo || nroTubo === "undefined") return;

        const tuboRef = doc(db, "inspecciones_live", idFirebase, "tubos", nroTubo);
        setDoc(tuboRef, {
          tuboNro: Number(nroTubo),
          desgaste: d.desgaste || "",
          corrosion: d.corrosion || "",
          tipo: d.tipo || "",
          cupla_status: d.cupla_status || d.cupla || "",
          updatedAt: serverTimestamp()
        }, { merge: true }).catch(() => {});
      });
    }

    // Disparamos la sincronización apenas abre la página
    sincronizarLiveDeFondo();
    window.addEventListener('online', sincronizarLiveDeFondo);


    /* ===== LÓGICA DE SELECCIÓN (ESTILO CUPLA) ===== */
    let seleccionados = [];

    // Cargar previos
    if (itvInit && itvInit.draft && itvInit.draft.tipo && itvInit.draft.tipo !== 'UNGRADE' && itvInit.draft.tipo !== '-') {
      seleccionados = itvInit.draft.tipo.split(' + ').map(s => s.trim()).filter(Boolean);
    }

    const botones = document.querySelectorAll('.tipo-btn');
    const banner = document.getElementById('seleccion-banner');
    const bannerTexto = document.getElementById('seleccion-texto');
    const bannerCambiar = document.getElementById('seleccion-cambiar');
    const btnSiguiente = document.getElementById('btnSiguiente');

    function actualizarVista() {
      botones.forEach(btn => {
        const codigo = btn.getAttribute('data-code');
        if (seleccionados.includes(codigo)) {
          btn.classList.add('selected');
        } else {
          btn.classList.remove('selected');
        }
      });

      if (seleccionados.length > 0) {
        banner.hidden = false;
        bannerTexto.textContent = `Selección: ${seleccionados.join(' + ')}`;
        btnSiguiente.disabled = false;
      } else {
        banner.hidden = true;
        btnSiguiente.disabled = true;
      }
    }

    actualizarVista();

    botones.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const codigo = btn.getAttribute('data-code');

        if (seleccionados.includes(codigo)) {
          seleccionados = seleccionados.filter(item => item !== codigo);
        } else {
          seleccionados.push(codigo);
        }
        actualizarVista();
      });
    });

    bannerCambiar.addEventListener('click', () => {
      seleccionados = [];
      actualizarVista();
    });

    document.getElementById('btnVolverAtras').addEventListener('click', () => {
      window.location.href = 'corrosion.html?v=' + Date.now();
    });

    // ==========================================
    // BOTÓN SIGUIENTE: SOLO GUARDA LOCAL Y SALTA. ¡NO TOCA FIREBASE!
    // ==========================================
    btnSiguiente.addEventListener('click', () => {
       const itv2 = loadIntervencion(); if (!itv2) return;

       const tipoString = seleccionados.join(' + ');
       itv2.draft.tipo = tipoString;
       
       saveIntervencion(itv2);
       syncTubeFromDraft();
       pushEvento('tipoSeleccionado', { tipo: tipoString });

       // ACÁ SACAMOS EL SETDOC PARA QUE NO HAYA PROBLEMAS DE RED NI BLOQUEOS.
       // LA PRÓXIMA PANTALLA SE ENCARGARÁ DE SUBIR ESTE DRAFT A FIREBASE.

       window.location.href = 'cupla.html?v=' + Date.now();
    });
  </script>
</body>
</html>