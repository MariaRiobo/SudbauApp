<!DOCTYPE html>

<html lang="es">

<head>

  <meta charset="UTF-8" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Tipo de Tubo</title>

  <meta name="theme-color" content="#0055AA">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Sudba칲 App: Modo Operador Activo'))
          .catch(err => console.log('Error al registrar Service Worker', err));
      });
    }
  </script>

  <link rel="stylesheet" href="css/app.css" />

  <link rel="preconnect" href="https://fonts.googleapis.com">

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

</head>



<body>

  <div class="container container-large container-wide">



    <div class="header-corrosion">

      <div class="header-left">

        <img src="img/logo.png" alt="Logo de la empresa" class="logo">

        <div class="titulo-y-tubo">

          <p class="subtitulo-tubo">Tubo N췈 <span id="numero-tubo"></span></p>

          <h1 class="title">TIPO</h1>

        </div>

      </div>

    </div>



    <div class="tipo-container">

      <div class="tipo-item"><a href="./cupla.html" class="tipo-btn">CO</a><p>Corrosi칩n</p></div>

      <div class="tipo-item"><a href="./cupla.html" class="tipo-btn">DG</a><p>Desgaste general</p></div>

      <div class="tipo-item"><a href="./cupla.html" class="tipo-btn">DC</a><p>Desgaste cu침a/contra</p></div>

      <div class="tipo-item"><a href="./cupla.html" class="tipo-btn">DP</a><p>Desgaste puntual</p></div>

      <div class="tipo-item"><a href="./cupla.html" class="tipo-btn">TR</a><p>Tubing roto</p></div>

      <div class="tipo-item"><a href="./cupla.html" class="tipo-btn">TT</a><p>Tubing torcido</p></div>

      <div class="tipo-item"><a href="./cupla.html" class="tipo-btn">TP</a><p>Tubing pinchado</p></div>

      <div class="tipo-item"><a href="./cupla.html" class="tipo-btn">RV</a><p>Rozamiento de varilla</p></div>

      <div class="tipo-item tipo-span-2"><a href="./cupla.html" class="tipo-btn">UG</a><p>Ungraded</p></div>

    </div>



    <div class="controles">

      <a href="Corrosion.html" class="btn-volver">Atr치s</a>

    </div>

  </div>



  <script>

    /* ===== Local storage ===== */

    function loadIntervencion() {

      const raw = localStorage.getItem('intervencionActual');

      if (!raw) { window.location.href = 'InicioSesion.html'; return null; }

      const itv = JSON.parse(raw);

      if (!itv.draft) itv.draft = {};

      if (!itv.eventos) itv.eventos = [];

      return itv;

    }

    function saveIntervencion(itv) {

      localStorage.setItem('intervencionActual', JSON.stringify(itv));

    }

    function pushEvento(tipo, extra = {}) {

      const itv = loadIntervencion(); if (!itv) return;

      itv.eventos.push({

        tipo,

        tubo: Number(itv.tuboActual),

        at: new Date().toISOString(),

        ...extra

      });

      saveIntervencion(itv);

    }



    /* ===== Helpers para tubos[] ===== */

    function loadTubes(){ return JSON.parse(localStorage.getItem('tubos') || '[]'); }

    function saveTubes(arr){ localStorage.setItem('tubos', JSON.stringify(arr)); }

    function ensureTubeIndex(tubes, idx){

      while (tubes.length <= idx) tubes.push({ nro: tubes.length + 1, draft: {}, completedAt: null });

      return tubes[idx];

    }

    function currentTubeIndex(itv){ return Number(itv.tuboActual || 1) - 1; }



    function syncDraftFromTube(){

      const itv = loadIntervencion(); if (!itv) return;

      const tubes = loadTubes();

      const idx = currentTubeIndex(itv);

      const t = ensureTubeIndex(tubes, idx);

      itv.draft = { ...(t.draft||{}), ...(itv.draft||{}) };

      saveIntervencion(itv);

    }

    function syncTubeFromDraft(){

      const itv = loadIntervencion(); if (!itv) return;

      const tubes = loadTubes();

      const idx = currentTubeIndex(itv);

      const t = ensureTubeIndex(tubes, idx);

      t.draft = { ...(t.draft||{}), ...(itv.draft||{}) };

      saveTubes(tubes);

    }



    /* ===== Init ===== */

    const itv = loadIntervencion();

    if (itv) {

      syncDraftFromTube(); // 游녣 precarga si est치s editando

      const numeroTuboSpan = document.getElementById('numero-tubo');

      if (numeroTuboSpan) numeroTuboSpan.textContent = itv.tuboActual;

    }



    /* ===== Guardar TIPO y navegar ===== */

    document.querySelectorAll('.tipo-btn').forEach(a => {

      a.addEventListener('click', (e) => {

        e.preventDefault();



        const code = e.currentTarget.textContent.trim(); // CO, DG, etc.

        const itv2 = loadIntervencion(); if (!itv2) return;



        itv2.draft.tipo = code;

        saveIntervencion(itv2);



        // NUEVO: persistir por tubo

        syncTubeFromDraft();



        pushEvento('tipoSeleccionado', { tipo: code });



        window.location.href = e.currentTarget.getAttribute('href'); // cupla.html

      });

    });

  </script>

</body>

</html>
